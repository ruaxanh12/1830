<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ch·∫∑ng ƒë∆∞·ªùng c·ªßa ch√∫ng m√¨nh</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  background:url('background.jpg') center/cover fixed;
  color:#f2f2f2;
  overflow:hidden;
  text-align:center;
}

#hearts{
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
}

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  transition:background 3s ease;
  z-index:1;
}
.overlay.dark{background:rgba(0,0,0,.85);}

.container{
  position:relative;
  z-index:2;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}

button{
  padding:12px 26px;
  border:none;
  border-radius:30px;
  background:#ff5c8a;
  color:#fff;
  font-size:1rem;
  cursor:pointer;
}

.memory{
  display:none;
  animation:fadeIn 1.8s ease forwards;
}

.memory.fade-out{
  animation:fadeOut 1.2s ease forwards;
}

.memory img{
  width:90%;
  max-width:420px;
  border-radius:18px;
  box-shadow:0 15px 40px rgba(0,0,0,.6);
}

audio{display:none;}

@keyframes fadeIn{
  from{opacity:0; transform:scale(.97);}
  to{opacity:1; transform:scale(1);}
}

@keyframes fadeOut{
  to{opacity:0; transform:scale(1.03);}
}
</style>
</head>

<body>

<canvas id="hearts"></canvas>
<div class="overlay"></div>

<audio id="bgMusic" src="piano.m4a" loop></audio>

<div class="container" id="intro">
  <h1>Ch·∫∑ng ƒë∆∞·ªùng c·ªßa ch√∫ng m√¨nh</h1>
  <p>T·ª´ng kho·∫£nh kh·∫Øc, anh v·∫´n nh·ªõ.</p>
  <button onclick="startStory()">B·∫Øt ƒë·∫ßu</button>
</div>

<div class="container" id="story" style="display:none">

  <div class="memory" id="m1">
    <img src="img1.jpg">
    <audio id="a1" src="voice1.m4a" preload="auto"></audio>
  </div>

  <div class="memory" id="m2">
    <img src="img2.jpg">
    <audio id="a2" src="voice2.m4a" preload="auto"></audio>
  </div>

  <div class="memory" id="m3">
    <img src="img3.jpg">
    <audio id="a3" src="voice3.m4a" preload="auto"></audio>
  </div>

  <div class="memory" id="m4">
    <img src="img4.jpg">
    <audio id="a4" src="voice4.m4a" preload="auto"></audio>
  </div>

  <div class="memory" id="m5">
    <img src="img5.jpg">
    <audio id="a5" src="voice5.m4a" preload="auto"></audio>
  </div>

  <div class="memory" id="ending">
    <h2>I LOVE YOU üíô</h2>
    <button onclick="location.reload()">Xem l·∫°i</button>
  </div>

</div>

<script>
let current=1;
let audioUnlocked=false;

/* ‚≠ê ULTRA STABLE AUDIO UNLOCK */
function unlockAudioSystem(){
  if(audioUnlocked) return;

  const AudioContext = window.AudioContext || window.webkitAudioContext;
  const ctx = new AudioContext();

  const buffer = ctx.createBuffer(1, 1, 22050);
  const source = ctx.createBufferSource();
  source.buffer = buffer;
  source.connect(ctx.destination);
  source.start(0);

  audioUnlocked=true;
}

/* ‚≠ê PRELOAD */
function preloadAudios(){
  for(let i=1;i<=5;i++){
    document.getElementById('a'+i).load();
  }
}

function startStory(){
  unlockAudioSystem();
  preloadAudios();

  const bg=document.getElementById('bgMusic');
  bg.currentTime=0;
  bg.volume=0;
  bg.play().catch(()=>{});
  fadeIn(bg,3000);

  document.getElementById('intro').style.display='none';
  document.getElementById('story').style.display='flex';

  playMemory(1);
}

/* ‚≠ê PLAYBACK */
async function playMemory(n){
  const m=document.getElementById('m'+n);
  const a=document.getElementById('a'+n);

  m.style.display='block';

  try{
    duckMusic(true);  // ‚≠ê gi·∫£m nh·∫°c khi voice n√≥i
    await playAudioSafely(a);
  }catch{}

  duckMusic(false); // ‚≠ê tr·∫£ nh·∫°c v·ªÅ n·ªÅn

  m.classList.add('fade-out');

  setTimeout(()=>{
    m.style.display='none';
    m.classList.remove('fade-out');

    current++;
    if(current<=5) playMemory(current);
    else showEnding();
  },1200);
}

function playAudioSafely(audio){
  return new Promise((resolve,reject)=>{
    audio.currentTime=0;
    const playPromise=audio.play();

    if(playPromise!==undefined){
      playPromise.then(()=>{
        audio.onended=resolve;

        setTimeout(()=>{
          if(audio.paused) resolve();
        }, audio.duration*1000 + 500);

      }).catch(reject);
    }else reject();
  });
}

function showEnding(){
  document.querySelector('.overlay').classList.add('dark');
  document.getElementById('ending').style.display='block';
  fadeOut(document.getElementById('bgMusic'),4000);
}

/* üíô CINEMATIC MIX */
function duckMusic(active){
  const bg=document.getElementById('bgMusic');

  if(active){
    bg.volume = 0.05;  // ‚≠ê n·ªÅn r·∫•t nh·∫π khi voice n√≥i
  }else{
    bg.volume = 0.12;  // ‚≠ê n·ªÅn chu·∫©n ƒëi·ªán ·∫£nh
  }
}

function fadeIn(audio,d){
  let v=0;
  const i=setInterval(()=>{
    v+=0.02;
    audio.volume=Math.min(v,0.12); // ‚≠ê GI·∫¢M NH·∫†C
    if(v>=0.12) clearInterval(i);
  },d*0.02);
}

function fadeOut(audio,d){
  let v=audio.volume;
  const i=setInterval(()=>{
    v-=0.02;
    audio.volume=Math.max(v,0);
    if(v<=0){audio.pause();clearInterval(i);}
  },d*0.02);
}

/* üíó HEARTS */
const canvas=document.getElementById("hearts");
const ctx=canvas.getContext("2d");

canvas.width=window.innerWidth;
canvas.height=window.innerHeight;

let hearts=[];

function createHeart(){
  return{
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height,
    size:Math.random()*26+14,
    speed:Math.random()*0.5+0.2,
    drift:(Math.random()-0.5)*0.3,
    opacity:Math.random()*0.4+0.2
  };
}

for(let i=0;i<30;i++) hearts.push(createHeart());

function drawHeart(x,y,s,o){
  ctx.save();
  ctx.globalAlpha=o;
  ctx.beginPath();
  ctx.moveTo(x,y);
  ctx.bezierCurveTo(x-s,y-s,x-2*s,y+s,x,y+2*s);
  ctx.bezierCurveTo(x+2*s,y+s,x+s,y-s,x,y);
  ctx.fillStyle="rgba(255,92,138,1)";
  ctx.fill();
  ctx.restore();
}

function animateHearts(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  hearts.forEach((h,i)=>{
    drawHeart(h.x,h.y,h.size/4,h.opacity);
    h.y-=h.speed;
    h.x+=h.drift;

    if(h.y<-30){
      hearts[i]=createHeart();
      hearts[i].y=canvas.height+30;
    }
  });

  requestAnimationFrame(animateHearts);
}

animateHearts();
</script>

</body>
</html>
